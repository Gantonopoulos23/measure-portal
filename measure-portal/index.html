<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Measure Portal</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg: #0a0a0a;            /* Apple-like dark, can flip to light easily */
      --card: #111111;
      --card-2: #161616;
      --text: #f5f5f7;          /* off-white Apple tint */
      --muted: #a1a1a1;
      --border: #2a2a2a;
      --accent: #0071e3;        /* Apple blue */
      --radius: 14px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --pad: 5px;               /* outer page padding */
      --header-h: 72px;
      --footer-h: 56px;
      --gap: 12px;
    }

    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0; padding: var(--pad);
      background: var(--bg); color: var(--text);
      font: 15px/1.5 -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, Helvetica, Arial, system-ui;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }

    .shell{
      height: calc(100svh - var(--pad)*2); /* mobile-safe viewport */
      height: calc(100vh  - var(--pad)*2);
      width:  calc(100vw  - var(--pad)*2);
      display:grid;
      grid-template-rows: var(--header-h) 1fr var(--footer-h);
      gap: var(--gap);
    }

    /* Header */
    header{
      display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px;
      padding: 0 8px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo{
      width:28px; height:28px; border-radius:8px; background:linear-gradient(145deg,#1c1c1c,#0e0e0e);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 6px 14px rgba(0,0,0,.45);
    }
    .brand h1{
      font-size:18px; font-weight:600; letter-spacing:.2px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .hdr-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      appearance: none; cursor:pointer; user-select:none;
      background: var(--card-2); color: var(--text);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 14px; font-weight:600;
      transition: transform .06s ease, filter .2s ease;
    }
    .btn:hover{ filter: brightness(1.1); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: var(--accent); border-color: transparent; color: white; }

    /* Main area: two states -> auth or dashboard */
    main{ position:relative; }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* Auth view */
    #auth{
      height:100%; display:grid; place-items:center; padding: 12px;
    }
    .auth-card{
      width: 100%; max-width: 520px; padding: 28px; gap: 18px;
      display:grid;
    }
    .tabs{ display:flex; gap:8px; background: var(--card-2); padding:6px; border-radius:10px; border:1px solid var(--border); }
    .tab{ flex:1; text-align:center; padding:10px 12px; border-radius:8px; font-weight:600; cursor:pointer; }
    .tab.active{ background:#0f0f0f; border:1px solid var(--border); }

    form{ display:grid; gap: 14px; margin-top: 8px; }
    label{ font-size:13px; color: var(--muted); }
    input, .input{
      width:100%; padding: 12px 14px; border-radius: 10px;
      border: 1px solid var(--border); background: #0f0f10; color: var(--text);
      outline:none;
    }
    input:focus{ border-color: #3a3a3a; box-shadow: 0 0 0 3px rgba(0,113,227,.2); }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }

    .hint{ font-size:12px; color: var(--muted); }
    .error{ font-size:13px; color: #ff6767; display:none; }

    /* Dashboard view */
    #dash{ height:100%; display:none; grid-template-rows: 1fr; }
    .report-wrap{ position:relative; height:100%; }
    .report-card{ height:100%; width:100%; overflow:hidden; border-radius: 12px; border:1px solid var(--border); background: var(--card); box-shadow: var(--shadow); }
    .report-card iframe{ width:100%; height:100%; border:0; display:block; }
    .report-fallback{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; text-align:center; color:var(--muted); padding:20px; }
    .report-fallback a{ color:#fff; text-decoration:underline; }

    footer{
      display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 0 6px; color:var(--muted); font-size:12px; flex-wrap:wrap;
    }

    @media (max-width:640px){
      .row{ grid-template-columns: 1fr; }
      .auth-card{ padding: 22px; }
      .brand h1{ font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Measure Portal</h1>
      </div>
      <div class="hdr-right">
        <button id="signOutBtn" class="btn" style="display:none;">Αποσύνδεση</button>
      </div>
    </header>

    <main>
      <!-- AUTH VIEW -->
      <section id="auth">
        <div class="card auth-card">
          <div class="tabs" role="tablist">
            <div id="tabLogin" class="tab active" role="tab" aria-controls="panelLogin">Σύνδεση</div>
            <div id="tabSignup" class="tab" role="tab" aria-controls="panelSignup">Δημιουργία λογαριασμού</div>
          </div>

          <!-- Login form -->
          <form id="panelLogin" autocomplete="on">
            <div class="input-group">
              <label for="loginEmail">Email</label>
              <input id="loginEmail" name="email" type="email" required placeholder="name@company.com" />
            </div>
            <div class="input-group">
              <label for="loginPassword">Κωδικός</label>
              <input id="loginPassword" name="password" type="password" required placeholder="••••••••" />
            </div>
            <div class="error" id="loginError">Λάθος στοιχεία σύνδεσης.</div>
            <button class="btn primary" type="submit">Είσοδος</button>
            <div class="hint">Με την είσοδό σας αποδέχεστε τους όρους χρήσης & πολιτική απορρήτου.</div>
          </form>

          <!-- Signup form -->
          <form id="panelSignup" style="display:none;">
            <div class="row">
              <div class="input-group">
                <label for="name">Ονομα</label>
                <input id="name" name="name" required placeholder="Πλήρες όνομα" />
              </div>
              <div class="input-group">
                <label for="company">Εταιρεία</label>
                <input id="company" name="company" required placeholder="Επωνυμία" />
              </div>
            </div>
            <div class="input-group">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" required placeholder="name@company.com" />
            </div>
            <div class="row">
              <div class="input-group">
                <label for="password">Κωδικός</label>
                <input id="password" name="password" type="password" minlength="8" required placeholder="τουλ. 8 χαρακτήρες" />
              </div>
              <div class="input-group">
                <label for="reportUrl">Power BI Report URL</label>
                <input id="reportUrl" name="report_url" type="url" required placeholder="https://app.powerbi.com/view?r=..." />
              </div>
            </div>
            <div class="error" id="signupError">Αδυναμία δημιουργίας λογαριασμού.</div>
            <button class="btn primary" type="submit">Δημιουργία</button>
            <div class="hint">Τα στοιχεία θα αποθηκευτούν με ασφάλεια. Δεν κρατάμε plain passwords.</div>
          </form>
        </div>
      </section>

      <!-- DASHBOARD VIEW -->
      <section id="dash">
        <div class="report-wrap">
          <div class="report-card">
            <iframe id="pbiFrame" title="Measure's Report" src="" allow="fullscreen" allowfullscreen></iframe>
            <div class="report-fallback" id="reportFallback">
              <div>
                <p>Δεν ήταν δυνατό να φορτωθεί το Power BI. Δοκίμασε να ανοίξεις το report σε νέο παράθυρο:</p>
                <p><a id="reportLink" href="#" target="_blank" rel="noopener">Άνοιγμα Report</a></p>
                <p class="hint">Σε mobile in‑app webviews ίσως μπλοκάρεται το embed. Άνοιξε σε Safari/Chrome.</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div>© Η Εταιρεία μου</div>
      <div class="hint">Minimal, Apple‑style αισθητική</div>
    </footer>
  </div>

  <script>
    // === Simple front-end SPA logic ===
    const tabLogin = document.getElementById('tabLogin');
    const tabSignup = document.getElementById('tabSignup');
    const panelLogin = document.getElementById('panelLogin');
    const panelSignup = document.getElementById('panelSignup');
    const auth = document.getElementById('auth');
    const dash = document.getElementById('dash');
    const loginError = document.getElementById('loginError');
    const signupError = document.getElementById('signupError');
    const signOutBtn = document.getElementById('signOutBtn');
    const pbiFrame = document.getElementById('pbiFrame');
    const reportFallback = document.getElementById('reportFallback');
    const reportLink = document.getElementById('reportLink');

    // Tabs toggle
    tabLogin.addEventListener('click', () => {
      tabLogin.classList.add('active');
      tabSignup.classList.remove('active');
      panelLogin.style.display = '';
      panelSignup.style.display = 'none';
    });
    tabSignup.addEventListener('click', () => {
      tabSignup.classList.add('active');
      tabLogin.classList.remove('active');
      panelSignup.style.display = '';
      panelLogin.style.display = 'none';
    });

    // Restore session from localStorage
    const saved = JSON.parse(localStorage.getItem('session') || 'null');
    if(saved && saved.token && saved.report_url){
      showDashboard(saved.report_url);
    }

    // Login submit
    panelLogin.addEventListener('submit', async (e) => {
      e.preventDefault(); loginError.style.display = 'none';
      const form = new FormData(panelLogin);
      const payload = { email: form.get('email'), password: form.get('password') };
      try{
        const res = await fetch('/api/login', {
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('bad');
        const data = await res.json();
        // Expect: { token, name, company, report_url }
        localStorage.setItem('session', JSON.stringify(data));
        showDashboard(data.report_url);
      }catch(err){
        loginError.style.display = 'block';
      }
    });

    // Signup submit
    panelSignup.addEventListener('submit', async (e) => {
      e.preventDefault(); signupError.style.display = 'none';
      const form = new FormData(panelSignup);
      const payload = {
        name: form.get('name'), company: form.get('company'), email: form.get('email'), password: form.get('password'), report_url: form.get('report_url')
      };
      try{
        const res = await fetch('/api/signup', {
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('bad');
        const data = await res.json();
        // Auto-login after signup
        localStorage.setItem('session', JSON.stringify(data));
        showDashboard(data.report_url);
      }catch(err){
        signupError.style.display = 'block';
      }
    });

    function showDashboard(reportUrl){
      auth.style.display = 'none';
      dash.style.display = 'grid';
      signOutBtn.style.display = 'inline-flex';
      pbiFrame.src = reportUrl;
      reportLink.href = reportUrl;
      // Fallback if frame doesn't visualize in ~5s
      const t = setTimeout(()=>{ reportFallback.style.display = 'flex'; }, 5000);
      pbiFrame.addEventListener('load', ()=>{ clearTimeout(t); reportFallback.style.display = 'none'; }, { once:true });
    }

    signOutBtn.addEventListener('click', () => {
      localStorage.removeItem('session'); location.reload();
    });
  </script>
</body>
</html>
